@page "/upload_app"
@using AppMarketplaceBlazorFront.DTOs
@using TusBlazorClient
@inject HttpClient httpClient
@inject TusClient tusClient;
@inject IJSRuntime JS;

<div class="upload-app-page">
	<div class="website-title">AppMarket</div>
	<div class="nice-frame-div">
		<img class="nice-frame" src="/AllAppsBeutyFrame.jpg" />
		<div class="nice-frame-text">Загрузите приложение</div>
	</div>
	<div class="app-info-div">
		<div class="img-upload-div">
			<div class="img-upload-label">Изображение приложения</div>
			<div class="upload-img-grid">
				<div class="upload-img-info">PNG, JPG, WEBP</div>
				<button class="upload-img-button">Загрузить</button>
			</div>
		</div>
		<div class="app-desc-div">
			<div class="img-upload-label">Загрузите приложение</div>
			<div class="upload-img-grid">
				<div class="upload-img-info">Zip, Rar, 7Zip, tgz. Макс. размер: 100GB</div>
				<label for="file-upload" class="upload-img-button">
					Загрузить
				</label>
				<input class="hide-input" id="file-upload" type="file"/>

			</div>
			<div class="desc-input-label">Название<div class="desc-star-mark">*</div></div>
			<input class="desc-input" placeholder="к примеру: No Cap App" @bind=Name/>
			<div class="desc-input-label">Краткое описание<div class="desc-star-mark">*</div></div>
			<input class="desc-input" placeholder="например: Приложение для развития памяти" @bind=SpecialDescription />
			<div class="desc-input-label">Описание<div class="desc-star-mark">*</div></div>
			<textarea class="desc-input" placeholder="например: Приложение для развития памяти" @bind=Description />
			<div class="desc-input-label">Цена<div class="desc-star-mark">*</div></div>
			<input class="desc-input" type="number" placeholder="0" @bind=Price/>
			<div class="desc-input-label">Категория<div class="desc-star-mark">*</div></div>
			<select class="select-category" id="select-category">
				@if(_appCategories != null)
				{
					@foreach (var category in _appCategories)
					{
						<option value=@category.CategoryId.ToString()>@category.CategoryName</option>
					}
				}
			</select>
			<button class="upload-button" @onclick=Upload>Загрузить</button>
			<div id="upload-pb" class="upload-pb-hide">
				<div class="progress">
					<div id="upload-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	IEnumerable<AppCategory>? _appCategories;

	string Name { get; set; } = "";
	string Description { get; set; } = "";
	string SpecialDescription { get; set; } = "";
	uint Price { get; set; } = 0;

	protected override async Task OnInitializedAsync()
	{
		string endpoint = "https://localhost:7247/api/AppCategories/GetAppCategories";

		_appCategories = await httpClient.GetFromJsonAsync<IEnumerable<AppCategory>>(endpoint);
	}

	private IJSObjectReference MyJsModule { get; set; } = null!;
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			// Load the JS Helpers Module
			MyJsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./Pages/UploadApp.razor.js");
		}
	}

	private async Task Upload()
	{
		await MyJsModule.InvokeVoidAsync("UploadAppJs", Name, Description, SpecialDescription, Price);
	}
}
